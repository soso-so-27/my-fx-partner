# AIトレードルールレビュー機能 実装計画

## 概要
ユーザーが自身のトレードルール（エントリー条件、リスク管理、メンタルルールなど）を登録し、実際のトレード記録時にAIがそのルールを遵守しているかを自動的にレビュー・フィードバックする機能。

## 1. データ構造: トレードルール
ユーザーごとにカスタマイズ可能なルールセットを定義します。

```typescript
interface TradeRule {
  id: string
  userId: string
  title: string          // ルール名（例: "リスクリワード 1:2以上"）
  category: 'ENTRY' | 'EXIT' | 'RISK' | 'MENTAL'
  description: string    // 詳細な説明
  isActive: boolean
  // オプション: 数値的な制約（プログラムでチェック可能な場合）
  constraints?: {
    minRiskReward?: number
    maxRiskPercent?: number
    allowedPairs?: string[]
    tradingHours?: { start: string, end: string }
  }
}
```

## 2. ユーザーインターフェース (UI)

### ルール登録・管理画面 (`/settings/rules`)
- カテゴリごとにルールを追加・編集・削除できるフォーム
- プリセットルールの提供（初心者向けテンプレート）
  - 「損切りは必ずエントリー時に設定する」
  - 「1トレードのリスクは資金の2%以内」
  - 「重要指標発表前後30分はエントリーしない」

### トレード記録時のUI (`/chat`)
- トレード記録完了後、AIからのフィードバックを表示するエリアを追加
- ルール遵守状況を視覚的に表示（✅ 遵守 / ⚠️ 注意 / ❌ 違反）

## 3. AIレビューロジック

### プロンプトエンジニアリング
AIに対して、以下の情報を入力として与えます：
1. **ユーザーのトレードルール**: 登録されたアクティブなルール一覧
2. **トレードデータ**: 通貨ペア、価格、時間、メモ、画像解析結果
3. **市場状況（将来的な拡張）**: ボラティリティ、トレンドなど

**プロンプト例:**
```text
あなたはプロのFXコーチです。以下のユーザーの「トレードルール」に基づいて、今回の「トレード」を評価してください。

【トレードルール】
1. リスクリワードは1:2以上を狙うこと
2. 21:00〜24:00の時間帯のみ取引すること
3. 感情的なエントリー（飛び乗り）は禁止

【今回のトレード】
通貨ペア: USD/JPY
エントリー: 150.00, 損切り: 149.80, 利確: 150.40
時間: 22:15
メモ: 急上昇したので慌てて買った。

【評価依頼】
各ルールについて遵守しているか判定し、アドバイスを行ってください。
特に「メモ」の内容からメンタル面でのルール違反がないか厳しくチェックしてください。
```

## 4. 実装ステップ

### Phase 1: ルール登録機能
1. Supabaseに `trade_rules` テーブル作成
2. ルール設定画面の実装 (`src/app/settings/rules/page.tsx`)
3. ルール保存・読み込みのAPI実装

### Phase 2: AIレビュー統合
1. `ai-service.ts` を拡張し、`reviewTrade(trade, rules)` メソッドを追加
2. チャットインターフェースにレビュー表示コンポーネントを追加
3. トレード保存時に自動レビューを実行するオプション追加

### Phase 3: 振り返り・分析
1. ルールごとの遵守率をグラフ化
2. 「よく破るルール」の特定と改善提案

## 5. 運用アイディア

- **ウィークリーコーチング**: 週末に1週間のトレードをまとめてAIがレビューし、「今週の課題」を提示。
- **リアルタイム警告**: エントリー入力中に、入力値がルール（例：リスク許容額）を超えていたら警告を出す（これはAIではなくロジックで実装可能）。
